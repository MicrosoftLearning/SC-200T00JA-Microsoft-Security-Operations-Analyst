# モジュール 6 - ラボ 1 - 演習 2 - データコネクタを使用して Windows デバイスを Azure Sentinel に接続する

### タスク 1: Azure で Windows 仮想マシンを作成する

このタスクでは、Azure で Windows 仮想マシンを作成します。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは **Pa55w.rd** です。  

2. Microsoft Edge ブラウザーで Azure ポータルに移動します https://portal.azure.com

3. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール**アカウントをコピーして貼り付け、「**次へ**」を選択します。

4. **パスワードの入力**ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード** をコピーして貼り付け、「**サインイン**」を選択します。

5. 「**+ リソースの作成**」 を選択します。

6. 「**サービスとマーケットプレイスの検索**」 ボックスに、「*Windows 10*」と入力します。 

7. ドロップダウンで *Microsoft Windows10* を選択します。  次に、「**Windows 10　Enterprise　バージョン　20H2**」を選択し **作成** を選択します。

8. サブスクリプションを選択します。

9. まだ作成していない場合は、**rg-AZWIN01** という名前の新しいリソースグループを作成します。

**注:** これは、追跡目的の新しいリソース グループである必要があります。  

10. 仮想マシン名を AZWIN01 に設定します。

11. 適した地域に設定してください。  適切なリージョンが既定になる可能性があります。

12. Azure で使用できるユーザー名を入力します。

13. 任意のパスワードを入力します。 

**ヒント:** テナントパスワードを使用するのが最も簡単な方法です。

14. ライセンスのチェックボックスを選択します。

15. 「**確認 + 作成**」 を選択します。

16. 「**作成**」を選択します。リソースが作成されるのを待ちますこれには数分かかることがあります。

### タスク 2: Azure Windows 仮想マシンを接続する。

このタスクでは、Azure Windows 仮想マシンを Azure Sentinel に接続します。 

1. Azure ポータルの検索バーに 「*Sentinel*」 と入力し、「**Azure Sentinel**」 を選択します。

1. Azure Sentinel ワークスペースを選択します。

1. データ コネクタ タブで、リストから「**レガシーエージェントを使用したセキュリティ イベント**」コネクタを選択します。

1. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

1. 「**Install agent on Azure Windows Virtual Machine**」オプションを選択します。

1. 「**Azure Windows 仮想マシンのエージェントをダウンロードしてインストールする**」を選択します。

1. 前のタスクで作成したリストから **AZWIN01** 仮想マシンを選択し、「**接続**」を選択します。*接続しています...* メッセージが消えるまで待ちます。

1. ナビゲーションリストで「**仮想マシン**」を選択しますこれで、仮想マシンに LogAnalytics 接続があることがわかります。

### タスク 3: 非 Azure Windows 機械の接続

このタスクでは、非 Azure Windows 仮想マシンを AzureSentinel に接続します。   

1. 管理者として WIN2 仮想マシンにログインします。パスワードは **Pa55w.rd** です。  

2. Microsoft Edge ブラウザーを開きます。

3. ブラウザーを開き、以前のラボで使用していた資格情報を使用して、https://portal.azure.com で Azure portral にログインします。

4. Azure ポータルの検索バーに 「*Sentinel*」 と入力し、「**Azure Sentinel**」 を選択します。

5. Azure Sentinel ワークスペースを選択します。

6. 「**データ コネクタ**」 を選択し、リストから 「**レガシーエージェントを使用したセキュリティ イベント**」 コネクタを選択します。

7. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

8. ストリーミングするイベントの選択領域で、「**すべてのイベント**」を選択し、「**変更の適用**」を選択します。

9. 「**Install agent on non-Azure Windows Machine**」を選択します。

10. 「**Azure 以外の Windows マシンのエージェントをダウンロードしてインストールする**」を選択します。 

11. **Windows エージェントのダウンロード (64 ビット)** のリンクを選択します。

12. ダウンロードした .exe ファイルを実行し、ユーザー アカウント制御プロンプトが表示された場合は「**はい**」を実行します。

13. ウェルカム ダイアログで「**次へ**」を選択します。

14. マイクロソフト ソフトウェア ライセンス条項ページで「**同意します**」を選択します。  インストール先プロンプトで、「**次へ**」を選択します。

15. エージェントのセットアップ オプションプロンプトで、「**Azure ログ分析(OMS)にエージェントを接続する**」 オプションを選択し、「**次へ**」を選択します。

16. Azure Sentinel が開いているブラウザーで、「エージェントの管理」 ページから **ワークスペース ID** をコピーし、ダイアログのワークスペース ID に貼り付けます。 

17. Azure Sentinel が開いているブラウザーで、「エージェントの管理」 ページから**主キー**をコピーし、ダイアログの 「ワークスペース」 キーに貼り付けます。 

18. 「**次へ**」を選択します。

19. Microsoft Update ページで「**次へ**」を選択します。

20. 次に、「**インストール**」を選択します。  完了したら、**「完了」** を選択します。

### タスク 4: System Monitor（Sysmon）をインストールしてログを収集します。

このタスクでは、Sysmon をインストールして収集します。

引き続きWIN2 仮想マシンに接続する必要があります。  次の手順では、既定構成でSysmonをインストールします。.  実稼働マシンで使用するSysmonのコミュニティベースの構成を調査する必要があります

1. ブラウザーで、次のログイン URL に移動します。https://docs.microsoft.com/sysinternals/downloads/sysmon

2. **Download Sysmon**を選択して、Sysmon をダウンロードします。

3. ダウンロードした ZIP ファイルを開き、ファイルを新しいディレクトリ c:\sysmon に展開します。

4. WindowsのWIN2タスクバーの検索ボックスに*cmd*を入力します。  検索結果には、コマンド プロンプト アプリが表示されます。  コマンド プロンプト アプリを右クリックし、「**管理者として実行**」 を選択します。  表示されるユーザー アカウント制御のプロンプトを確認します。

5. *cd \sysmon* と入力する。

6. *notepad sysmon.xml* と入力して、新しいファイルを作成します。

7. ブラウザの別のタブで次のURLを開きます: https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml

8. 「**Raw**」ボタンを選択し、そのファイルの内容を Github から作成した sysmon.xml メモ帳ファイルにコピーしてファイルを**保存**します。

9. コマンドプロンプトで次のように入力し、Enterキーを押します。
    sysmon.exe -accepteula -i sysmon.xml

**注:**  「COnfiguration file validated」および「Sysmon started」というメッセージが出力に表示されることを確認します。

10. ブラウザで、https://portal.azure.com のAzureポータルに移動します 

11. Azure ポータルの検索バーに「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

12. Azure Sentinelで、構成領域から「**設定**」を選択し、「**ワークスペース設定 >**」タブを選択します

13. Azure Sentinel ワークスペースが選択されていることを確認してください。

14. 「設定」領域で「**エージェントの構成**」を選択します。

15. 「**Windows イベントログ**」タブを選択します。

16. 「**Windows イベントログの追加**」ボタンを選択します。

17. ログ名フィールドに「**Microsoft-Windows-Sysmon/Operational**」と入力します。

18. 「**適用**」を選択します。

### タスク 5: Microsoft Defender for Endpoint ディバイスをオンボードする。

このタスクでは、デバイスを Microsoft Defender for Endpoint にオンボードします。

**注:** このコースの最初のモジュールでラボを完了し、仮想マシンを保存した場合は、すでにこのタスクを実行しています。  そのラボ演習と同じ仮想マシンを使用している場合は、このタスクをスキップできます。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは **Pa55w.rd** です。  

2. Microsoft Edge ブラウザーで、Microsoft 365 Defender ポータル (https://security.microsoft.com) にアクセスし、現在ポータルにいない場合は、**テナントの電子メール**資格情報を使用してログインします。

3. 左側のメニュー バーから 「**設定**」 を選択し、「設定」 ページから 「**エンドポイント**」 を選択します。

4. デバイス管理セクションで **「オンボーディング」** を選択します。

5. 「**オンボード パッケージのダウンロード**」を選択します。

6. ダウンロードした .zip ファイルを解凍します。

7. **管理者**として Windows コマンドプロンプトを実行し、表示されるユーザーアカウント制御プロンプトに同意します。

8. WindowsDefenderATPLocalOnboardingScript.cmd ファイルを実行します。  **注** 既定では、ファイルは c:\ users \ admin \ downloads ディレクトリにあります。  スクリプトの質問に対して 「Y」 と回答します。 

9. ポータルの「オンボーディング」ページで、検出テスト スクリプトをコピーしてオープン コマンド　ウィンドウで実行します。  新しい**管理者: コマンド プロンプト** ウィンドウを開く必要があるかもしれません。Windows 検索バーで「*CMD*」と入力し、「**管理者として実行**」 を選択します。

10. 「エンドポイント」 領域の Microsoft 365 Defender ポータルで、「**デバイス インベントリ**」 を選択します。お使いになっているデバイスがリストに表示されます。

## 演習 3 に進みます。
