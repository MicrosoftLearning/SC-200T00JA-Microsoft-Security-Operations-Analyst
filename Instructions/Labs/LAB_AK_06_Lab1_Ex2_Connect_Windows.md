# モジュール 6 -ラボ 1 - 演習 2 - データ コネクタを使用して Windows デバイスを Azure Sentinel に接続する

### タスク 1: Azure で Windows 仮想マシンを作成する

このタスクでは、Azure で Windows 仮想マシンを作成します。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd** です。  

2. Microsoft Edgeブラウザーで Azure ポータルに移動します https://portal.azure.com。

3. **サインイン** ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントの電子メール**アカウントをコピーして貼り付け、「**次へ**」を選択します。

4. **パスワードの入力**ダイアログ ボックスで、ラボ ホスティング プロバイダーから提供された**テナントパスワード** をコピーして貼り付け、「**サインイン**」を選択します。

5. 「**+ リソースの作成**」 を選択します。

6. 「**サービスとマーケットプレイスの検索**」 ボックスに、「*Windows 10*」と入力します。 

7. *Microsoft Windows10* の**作成**ドロップダウンを選択します。  次に、「**Windows 10　Enterprise　バージョン　20H2**」を選択します。

8. サブスクリプションを選択します。

9. まだ作成していない場合は、**rg-AZWIN01** という名前の新しいリソース グループを作成します。

**注:** これは、追跡目的の新しいリソース グループである必要があります。  

10. 仮想マシン名を AZWIN01 に設定します。

11. 適した領域に設定してください。  適切なリージョンが既定になる可能性があります。

12. Azure で使用できるユーザー名を選択して入力します。

13. 任意のパスワードを入力します。 

**ヒント:** テナントパスワードを使用するのが最も簡単な方法です。

14. ライセンス確認を選択します。

15. 「**Review + create**」 を選択します。

16. 「**作成**」 を選択します。リソースが作成されるのを待ちますこれには数分かかることがあります。

### タスク 2: Azure Windows 仮想マシンを接続する。

このタスクでは、Azure Windows 仮想マシンを Azure Sentinel に接続します。

1. Azure portal の検索バーに「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

2. 先ほど作成した Azure Sentinel ワークスペースを選択します。

3. データ コネクタ タブで、リストから「**セキュリティ イベント**」コネクタを選択します。

4. プロンプトが表示されたら、Azure Sentinel ワークスペースを選択します。

5. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

6. 「**Windows 仮想マシンにエージェントをインストールする**」オプションを選択します。

7. 「**Azure Linux 仮想マシンのエージェントのダウンロードとインストール**」を選択します。

8. 前のタスクで作成したリストから **AZWIN01** 仮想マシンを選択し、「**接続**」を選択します。*接続...*メッセージが消えるまで待ちます。

9. ナビゲーションリストで「**仮想マシン**」を選択しますこれで、仮想マシンに LogAnalytics 接続があることがわかります。

### タスク 3: 非 Azure Windows マシンを接続する。

このタスクでは、非 Azure Windows 仮想マシンを Azure Sentinel に接続します。

1. 管理者として WIN2 仮想マシンにログインします。パスワードは**Pa55w.rd** です。  

2. Microsoft Edge ブラウザーを開きます。

3. ブラウザーを開き、以前のラボで使用していた資格情報を使用して、https://portal.azure.com で Azure portral にログインします。

4. Azureポータルの検索バーに 「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

5. Azure Sentinel ワークスペースを選択します。

6. 「**データ コネクタ**」 を選択し、リストから 「**セキュリティ イベント**」 コネクタを選択します。

7. コネクタ情報ブレードで「**コネクタページを開く**」を選択します。

8. ストリーミングするイベントの選択領域で、「**すべてのイベント**」を選択し、「**変更の適用**」を選択します。

9. 「**非 Azure Windows マシンにエージェントをインストールする**」を選択します。

10. 「**非 Azure Windows マシンのエージェントのダウンロードとインストール**」を選択します。 

11. **Windows エージェントのダウンロード (64 ビット)** のリンクを選択します。

12. ダウンロードした .exe ファイルを実行し、確認と表示される可能性のあるユーザー アカウント制御プロンプトを実行します。

13. ウェルカム ダイアログで「**次へ**」を選択します。

14. マイクロソフト ソフトウェア ライセンス条項ページで「**同意する**」を選択します。  宛先プロンプトで、「**次へ**」を選択します。

15. エージェントのセットアップ オプションプロンプトで、「**エージェントを Azure Log Analytics (OMS) に接続する**」オプションを選択し、「**次へ**」を選択します。

16. Azure Sentinel が開いているブラウザーで、「エージェントの管理」 ページから **ワークスペース ID** をコピーし、ダイアログのワークスペース ID に貼り付けます。 

17. Azure Sentinel が開いているブラウザーで、「エージェントの管理」 ページから**主キー**をコピーし、ダイアログの 「ワークスペース」 キーに貼り付けます。 

18. 「**次へ**」を選択します。

19. MicrosoftUpdateページで「**次へ**」を選択します。

20. 次に、「**インストール**」を選択します。  完了したら、**「完了」**を選択します。

### タスク 4: Sysmonログをインストールして収集します。

このタスクでは、Sysmonログをインストールして収集します。

引き続きWIN2 仮想マシンに接続する必要があります。  次の手順では、既定構成でSysmonをインストールします。.  実稼働マシンで使用するSysmonのコミュニティベースの構成を調査する必要があります

1. ブラウザーで、次のログイン URL に移動します。https://docs.microsoft.com/sysinternals/downloads/sysmon

2. **Sysmonのダウンロード**を選択して、ページからSysmonをダウンロードします。

3. ダウンロードしたファイルを開き、ファイルを新しいディレクトリc：\ sysmonに抽出します。

4. WindowsのWIN2タスクバーの検索ボックスに*コマンド*を入力します。  検索結果には、コマンド プロンプト アプリが表示されます。  コマンド プロンプト アプリを右クリックし、「**管理者として実行**」 を選択します。  表示されるユーザー アカウント制御のプロンプトを確認します。

5. *cd \sysmon* と入力します

6. *notepad sysmon.xml* と入力して、新しいファイルを作成します。

7. ブラウザの別のタブで次のURLを開きます: https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml

8. そのファイルの内容をGithubから作成したsysmon.xmlメモ帳ファイルにコピーしてファイルを保存します。

9. コマンドプロンプトで次のように入力し、Enterキーを押します。
    sysmon.exe -accepteula -i sysmon.xml

10. ブラウザで、https://portal.azure.comのAzureポータルに移動します 

11. Azure portal の検索バーに「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

12. Azure Sentinelで、構成領域から「**設定**」を選択し、「**ワークスペース設定 >**」タブを選択します

13. AzureSentinelワークスペースが選択されていることを確認してください。

14. 「設定」領域で「**エージェントの構成**」を選択します。

15. 「**Windows イベントログ**」タブを選択します。

16. 「**Windows イベントログの追加**」ボタンを選択します。

17. ログ名フィールドに「**Microsoft-Windows-Sysmon/Operational**」と入力します。

18. 「**適用**」を選択します。

### タスク 5: Microsoft Defender for Endpoint ディバイスをオンボードする。

このタスクでは、デバイスを Microsoft Defender for Endpoint にオンボードします。

**注:** このコースの最初のモジュールでラボを完了した場合は、すでにこのタスクを実行しています。  そのラボ演習と同じ仮想マシンを使用している場合は、このタスクをスキップできます。

1. 管理者として WIN1 仮想マシンにログインします。パスワードは**Pa55w.rd** です。  

2. Microsoft Edge ブラウザーで、Microsoft 365 Defender ポータル (https://security.microsoft.com) にアクセスし、現在ポータルにいない場合は、**テナントの電子メール**資格情報を使用してログインします。

3. 左側のメニュー バーから 「**設定**」 を選択し、「設定」 ページから 「**エンドポイント**」 を選択します。

4. デバイス管理セクションで **「オンボーディング」**を選択します。

5. 「**パッケージのダウンロード**」を選択します。

6. ダウンロードした.zipファイルを解凍します。

7. **管理者**としてWindowsコマンドプロンプトを実行し、表示されるユーザーアカウント制御プロンプトに同意します。

8. 管理者として抽出したばかりの WindowsDefenderATPLocalOnboardingScript.cmd ファイルを実行します。**注** 既定では、ファイルは c:\ users \ admin \ downloads ディレクトリにあります。スクリプトの質問に対して「Y」と回答します。 

9. ポータルの「オンボーディング」ページで、検出テスト スクリプトをコピーしてオープン コマンド　ウィンドウで実行します。  新しい**管理者: コマンド プロンプト** ウィンドウを開く必要があるかもしれません。Windows 検索バーで「*CMD*」と入力し、「**管理者として実行**」 を選択します。

10. 「エンドポイント」 領域の Microsoft 365 Defender ポータルで、「**デバイス インベントリ**」 を選択します。お使いになっているデバイスがリストに表示されます。

## 演習 3 に進みます。
