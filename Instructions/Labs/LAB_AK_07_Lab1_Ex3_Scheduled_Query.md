# モジュール 7 - ラボ 1 - 演習 3 - スケジュールされたクエリを作成する

### タスク 1: スケジュール済みクエリを作成します。

このタスクでは、スケジュールされたクエリを作成します。

1. 管理者として **WIN1** 仮想マシンにログインします。パスワードは **Pa55w.rd**。  

2. Azure Portal にログインします。

4. Azureポータルの検索バーに「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

5. Azure Sentinel ワークスペースを選択します。

6. **構成** 領域から「**分析**」を選択します。

7. **作成**ボタンを選択し、「**スケジュール済みクエリルール**]を選択します。

8. 全般タブで、名前に「*非アクティブなアカウントの名前サインイン試行*」を入力します。

9. **方針**で、「**Initial Access**」を選択します。

10. **重要度** では、「**中**」を選択します

11. 「**次へ: ルール ロジックを設定　>**」ボタンを選択します。

12. ルールクエリの場合は、次のKQLステートメントを貼り付けます。

```KQL
SigninLogs
| where ResultType == "50057"
| where ResultDescription =~ "User account is disabled. The account has been disabled by an administrator."
| summarize StartTimeUtc = min(TimeGenerated), EndTimeUtc = max(TimeGenerated), count(), applicationCount = dcount(AppDisplayName), 
applicationSet = makeset(AppDisplayName) by UserPrincipalName, IPAddress
| extend timestamp = StartTimeUtc, AccountCustomEntity = UserPrincipalName, IPCustomEntity = IPAddress
```

**警告:** 仮想マシンへの貼り付け機能を使用する場合。  追加 | （パイプ）文字を追加できます。  貼り付けたものが次の KQL ステートメントのようになっていることを確認してください。

13.「クエリ結果の表示」へのリンクを選択し実行でエラーが出ないことを確認してください。ただし、結果は表示されません。

14. 分析ルールウィザードに戻り、**クエリスケジュール設定** の「**クエリの実行間隔**」で、「**5**」「**分**」を選択します。

15. **次の時間分の過去のデータを参照します**で、「**1**」「**日**」を選択します。

16. **アラートのしきい値** では、オプションを変更しないでください。

17. **イベントグループ化** 領域では、選択したオプションとして、**すべてのイベントを単一のアラートにグループ化**が選択されたままにします。

18. 「**次: インシデント設定**」ボタンを選択します。  

19. インシデント設定タブで、既定のオプションを確認します。

20. 「**次へ: 自動応答**」ボタンを選択します。

21. **アラートの自動化**で、以前に作成したプレイブックの PostMessageTeamsｰOnAlert を選択します。

22. 「**次: レビュー**」ボタンを選択します。
  
23. 「**作成**」を選択します。

### タスク 2: 新しいルールをテストします。

このタスクでは、新しいスケジュールされたクエリルールのテストを作成します

1. Azureポータルの検索バーに「*Azure Active Directory*」と入力します。「**Azure Active Directory**」を選択します。

2. 「**ユーザー**」を選択します。

3. リストからユーザー「**ChristieCline**」を選択します。The Christie Cline | プロファイルページが表示されます。

4. 「**編集**」を選択します。

5. 中ほどにある **サインインのブロック**を「**はい**」に変更します。

6. 「**保存**」を選択します。

7. Inprivateモード で Edge を起動します（Chromeなど、別のブラウザでも大丈夫です）。

9. Inprivate モードで開いたブラウザで、https://portal.office.com に移動し、ユーザー ChristieC@**Tenant Email domain** でログインしてみます。パスワードは admin@ と同じです。すると、アカウントがロックされているという警告が表示されます。これは想定された動きです。

10. ブラウザーを閉じます。アラートが処理されるまで 10 分程度待ちます。

11.  Edge ブラウザーで Azure portal に移動します　https://portal.azure.com。

12. **サインイン**ダイアログ ボックスで、ラボのホスティングプロバイダーから提供された**テナントの電子メール**アカウントをコピーして貼り付け、「**次へ**」を選択します。

13. **パスワードの入力**ダイアログ ボックスで、ラボ ホスティング プロバイダーから管理者ユーザーに提供された**テナントパスワード** をコピーして貼り付け、「**サインイン**」を選択します。

14. Azure ポータルの検索バーに「*Sentinel*」と入力し、「**Azure Sentinel**」を選択します。

15. Azure Sentinel ワークスペースを選択します。

16. **インシデント** を選択します。

17. 最近のインシデントに「**非アクティブなアカウントの名前のサインイン試行**」インシデントが表示されます。  インシデントを選択し、右側のブレードの詳細情報を確認します。

18. Microsoft Teams を開きます。*SOC* チームに移動し、プレイブックによって投稿されたインシデントに関するメッセージを確認してください。

## 演習 4 に進みます。
